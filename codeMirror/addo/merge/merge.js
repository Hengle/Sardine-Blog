(function(A){if(typeof exports=="object"&&typeof module=="object"){A(require("../../lib/codemirror"),require("diff_match_patch"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","diff_match_patch"],A)}else{A(CodeMirror,diff_match_patch)}}})(function(m,K){var Z=m.Pos;var h="http://www.w3.org/2000/svg";function e(w,v){this.mv=w;this.type=v;this.classes=v=="left"?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}e.prototype={constructor:e,init:function(v,x,w){this.edit=this.mv.edit;(this.edit.state.diffViews||(this.edit.state.diffViews=[])).push(this);this.orig=m(v,C({value:x,readOnly:!this.mv.options.allowEditingOriginals},C(w)));this.orig.state.diffViews=[this];this.diff=Q(H(x),H(w.value));this.chunks=o(this.diff);this.diffOutOfDate=this.dealigned=false;this.showDifferences=w.showDifferences!==false;this.forceUpdate=p(this);q(this,true,false);D(this)},setShowDifferences:function(v){v=v!==false;if(v!=this.showDifferences){this.showDifferences=v;this.forceUpdate("full")}}};function T(v){if(v.diffOutOfDate){v.diff=Q(v.orig.getValue(),v.edit.getValue());v.chunks=o(v.diff);v.diffOutOfDate=false;m.signal(v.edit,"updateDiff",v.diff)}}var E=false;function p(y){var Aa={from:0,to:0,marked:[]};var Ad={from:0,to:0,marked:[]};var x,v=false;function z(Ae){E=true;v=false;if(Ae=="full"){if(y.svg){F(y.svg)}if(y.copyButtons){F(y.copyButtons)}X(y.edit,Aa.marked,y.classes);X(y.orig,Ad.marked,y.classes);Aa.from=Aa.to=Ad.from=Ad.to=0}T(y);if(y.showDifferences){R(y.edit,y.diff,Aa,DIFF_INSERT,y.classes);R(y.orig,y.diff,Ad,DIFF_DELETE,y.classes)}l(y);if(y.mv.options.connect=="align"){i(y)}E=false}function w(Ae){if(E){return}y.dealigned=true;Ab(Ae)}function Ab(Ae){if(E||v){return}clearTimeout(x);if(Ae===true){v=true}x=setTimeout(z,Ae===true?20:250)}function Ac(Af,Ae){if(!y.diffOutOfDate){y.diffOutOfDate=true;Aa.from=Aa.to=Ad.from=Ad.to=0}w(Ae.text.length-1!=Ae.to.line-Ae.from.line)}y.edit.on("change",Ac);y.orig.on("change",Ac);y.edit.on("markerAdded",w);y.edit.on("markerCleared",w);y.orig.on("markerAdded",w);y.orig.on("markerCleared",w);y.edit.on("viewportChange",function(){Ab(false)});y.orig.on("viewportChange",function(){Ab(false)});z();return z}function D(v){v.edit.on("scroll",function(){f(v,DIFF_INSERT)&&l(v)});v.orig.on("scroll",function(){f(v,DIFF_DELETE)&&l(v)})}function f(Ad,Am){if(Ad.diffOutOfDate){return false}if(!Ad.lockScroll){return true}var Ai,w,Aa=+new Date;if(Am==DIFF_INSERT){Ai=Ad.edit;w=Ad.orig}else{Ai=Ad.orig;w=Ad.edit}if(Ai.state.scrollSetBy==Ad&&(Ai.state.scrollSetAt||0)+50>Aa){return false}var x=Ai.getScrollInfo();if(Ad.mv.options.connect=="align"){Ak=x.top}else{var Aj=0.5*x.clientHeight,Ah=x.top+Aj;var Ae=Ai.lineAtHeight(Ah,"local");var Ag=V(Ad.chunks,Ae,Am==DIFF_INSERT);var Af=r(Ai,Am==DIFF_INSERT?Ag.edit:Ag.orig);var z=r(w,Am==DIFF_INSERT?Ag.orig:Ag.edit);var Al=(Ah-Af.top)/(Af.bot-Af.top);var Ak=(z.top-Aj)+Al*(z.bot-z.top);var Ac,Ab;if(Ak>x.top&&(Ab=x.top/Aj)<1){Ak=Ak*Ab+x.top*(1-Ab)}else{if((Ac=x.height-x.clientHeight-x.top)<Aj){var v=w.getScrollInfo();var y=v.height-v.clientHeight-Ak;if(y>Ac&&(Ab=Ac/Aj)<1){Ak=Ak*Ab+(v.height-v.clientHeight-Ac)*(1-Ab)}}}}w.scrollTo(x.left,Ak);w.state.scrollSetAt=Aa;w.state.scrollSetBy=Ad;return true}function r(x,v){var w=v.after;if(w==null){w=x.lastLine()+1}return{top:x.heightAtLine(v.before||0,"local"),bot:x.heightAtLine(w,"local")}}function q(x,w,v){x.lockScroll=w;if(w&&v!=false){f(x,DIFF_INSERT)&&l(x)}x.lockButton.innerHTML=w?"\u21db\u21da":"\u21db&nbsp;&nbsp;\u21da"}function X(y,x,w){for(var v=0;v<x.length;++v){var z=x[v];if(z instanceof m.TextMarker){z.clear()}else{if(z.parent){y.removeLineClass(z,"background",w.chunk);y.removeLineClass(z,"background",w.start);y.removeLineClass(z,"background",w.end)}}}x.length=0}function R(y,z,Aa,v,w){var x=y.getViewport();y.operation(function(){if(Aa.from==Aa.to||x.from-Aa.to>20||Aa.from-x.to>20){X(y,Aa.marked,w);n(y,z,v,Aa.marked,x.from,x.to,w);Aa.from=x.from;Aa.to=x.to}else{if(x.from<Aa.from){n(y,z,v,Aa.marked,x.from,Aa.from,w);Aa.from=x.from}if(x.to>Aa.to){n(y,z,v,Aa.marked,Aa.to,x.to,w);Aa.to=x.to}}})}function n(Ae,Aa,An,Am,Ai,x,Aj){var Ao=Z(0,0);var Al=Z(Ai,0),Ag=Ae.clipPos(Z(x-1));var Ah=An==DIFF_DELETE?Aj.del:Aj.insert;function z(Aw,Au){var At=Math.max(Ai,Aw),Ar=Math.min(x,Au);for(var As=At;As<Ar;++As){var Av=Ae.addLineClass(As,"background",Aj.chunk);if(As==Aw){Ae.addLineClass(Av,"background",Aj.start)}if(As==Au-1){Ae.addLineClass(Av,"background",Aj.end)}Am.push(Av)}if(Aw==Au&&At==Au&&Ar==Au){if(At){Am.push(Ae.addLineClass(At-1,"background",Aj.end))}else{Am.push(Ae.addLineClass(At,"background",Aj.start))}}}var y=0;for(var Ab=0;Ab<Aa.length;++Ab){var v=Aa[Ab],Ak=v[0],Ac=v[1];if(Ak==DIFF_EQUAL){var Ad=Ao.line+(t(Aa,Ab)?0:1);g(Ao,Ac);var Af=Ao.line+(b(Aa,Ab)?1:0);if(Af>Ad){if(Ab){z(y,Ad)}y=Af}}else{if(Ak==An){var Ap=g(Ao,Ac,true);var w=P(Al,Ao),Aq=O(Ag,Ap);if(!J(w,Aq)){Am.push(Ae.markText(w,Aq,{className:Ah}))}Ao=Ap}}}if(y<=Ao.line){z(y,Ao.line+1)}}function l(x){if(!x.showDifferences){return}if(x.svg){F(x.svg);var y=x.gap.offsetWidth;M(x.svg,"width",y,"height",x.gap.offsetHeight)}if(x.copyButtons){F(x.copyButtons)}var z=x.edit.getViewport(),v=x.orig.getViewport();var Ad=x.edit.getScrollInfo().top,Ac=x.orig.getScrollInfo().top;for(var Ab=0;Ab<x.chunks.length;Ab++){var Aa=x.chunks[Ab];if(Aa.editFrom<=z.to&&Aa.editTo>=z.from&&Aa.origFrom<=v.to&&Aa.origTo>=v.from){s(x,Aa,Ac,Ad,y)}}}function a(y,Aa){var x=0,v=0;for(var w=0;w<Aa.length;w++){var z=Aa[w];if(z.editTo>y&&z.editFrom<=y){return null}if(z.editFrom>y){break}x=z.editTo;v=z.origTo}return v+(y-x)}function U(z,Ab){var x=[];for(var w=0;w<z.chunks.length;w++){var v=z.chunks[w];x.push([v.origTo,v.editTo,Ab?a(v.editTo,Ab.chunks):null])}if(Ab){for(var w=0;w<Ab.chunks.length;w++){var v=Ab.chunks[w];for(var Aa=0;Aa<x.length;Aa++){var y=x[Aa];if(y[1]==v.editTo){Aa=-1;break}else{if(y[1]>v.editTo){break}}}if(Aa>-1){x.splice(Aa-1,0,[a(v.editTo,z.chunks),v.editTo,v.origTo])}}}return x}function i(w,v){if(!w.dealigned&&!v){return}if(!w.orig.curOp){return w.orig.operation(function(){i(w,v)})}w.dealigned=false;var Ac=w.mv.left==w?w.mv.right:w.mv.left;if(Ac){T(Ac);Ac.dealigned=false}var Ad=U(w,Ac);var Aa=w.mv.aligners;for(var z=0;z<Aa.length;z++){Aa[z].clear()}Aa.length=0;var y=[w.orig,w.edit],Ab=[];if(Ac){y.push(Ac.orig)}for(var z=0;z<y.length;z++){Ab.push(y[z].getScrollInfo().top)}for(var x=0;x<Ad.length;x++){j(y,Ad[x],Aa)}for(var z=0;z<y.length;z++){y[z].scrollTo(null,Ab[z])}}function j(w,Ac,v){var z=0,Aa=[];for(var y=0;y<w.length;y++){if(Ac[y]!=null){var Ab=w[y].heightAtLine(Ac[y],"local");Aa[y]=Ab;z=Math.max(z,Ab)}}for(var y=0;y<w.length;y++){if(Ac[y]!=null){var x=z-Aa[y];if(x>1){v.push(B(w[y],Ac[y],x))}}}}function B(z,y,v){var w=true;if(y>z.lastLine()){y--;w=false}var x=document.createElement("div");x.className="CodeMirror-merge-spacer";x.style.height=v+"px";x.style.minWidth="1px";return z.addLineWidget(y,x,{height:v,above:w})}function s(Ak,Aj,Ac,Ab,An){var Ae=Ak.type=="left";var Ah=Ak.orig.heightAtLine(Aj.origFrom,"local")-Ac;if(Ak.svg){var Aa=Ah;var Am=Ak.edit.heightAtLine(Aj.editFrom,"local")-Ab;if(Ae){var y=Aa;Aa=Am;Am=y}var v=Ak.orig.heightAtLine(Aj.origTo,"local")-Ac;var Al=Ak.edit.heightAtLine(Aj.editTo,"local")-Ab;if(Ae){var y=v;v=Al;Al=y}var Ai=" C "+An/2+" "+Am+" "+An/2+" "+Aa+" "+(An+2)+" "+Aa;var x=" C "+An/2+" "+v+" "+An/2+" "+Al+" -1 "+Al;M(Ak.svg.appendChild(document.createElementNS(h,"path")),"d","M -1 "+Am+Ai+" L "+(An+2)+" "+v+x+" z","class",Ak.classes.connect)}if(Ak.copyButtons){var z=Ak.copyButtons.appendChild(c("div",Ak.type=="left"?"\u21dd":"\u21dc","CodeMirror-merge-copy"));var Ad=Ak.mv.options.allowEditingOriginals;z.title=Ad?"Push to left":"Revert chunk";z.chunk=Aj;z.style.top=Ah+"px";if(Ad){var Af=Ak.orig.heightAtLine(Aj.editFrom,"local")-Ab;var Ag=Ak.copyButtons.appendChild(c("div",Ak.type=="right"?"\u21dd":"\u21dc","CodeMirror-merge-copy-reverse"));Ag.title="Push to right";Ag.chunk={editFrom:Aj.origFrom,editTo:Aj.origTo,origFrom:Aj.editFrom,origTo:Aj.editTo};Ag.style.top=Af+"px";Ak.type=="right"?Ag.style.left="2px":Ag.style.right="2px"}}}function k(y,x,w,v){if(y.diffOutOfDate){return}x.replaceRange(w.getRange(Z(v.origFrom,0),Z(v.origTo,0)),Z(v.editFrom,0),Z(v.editTo,0))}var S=m.MergeView=function(Ae,Af){if(!(this instanceof S)){return new S(Ae,Af)}this.options=Af;var z=Af.origLeft,Ag=Af.origRight==null?Af.orig:Af.origRight;var Ab=z!=null,Ad=Ag!=null;var y=1+(Ab?1:0)+(Ad?1:0);var Ak=[],Ah=this.left=null,w=this.right=null;var Al=this;if(Ab){Ah=this.left=new e(this,"left");var x=c("div",null,"CodeMirror-merge-pane");Ak.push(x);Ak.push(d(Ah))}var v=c("div",null,"CodeMirror-merge-pane");Ak.push(v);if(Ad){w=this.right=new e(this,"right");Ak.push(d(w));var Ai=c("div",null,"CodeMirror-merge-pane");Ak.push(Ai)}(Ad?Ai:v).className+=" CodeMirror-merge-pane-rightmost";Ak.push(c("div",null,null,"height: 0; clear: both;"));var Aa=this.wrap=Ae.appendChild(c("div",Ak,"CodeMirror-merge CodeMirror-merge-"+y+"pane"));this.edit=m(v,C(Af));if(Ah){Ah.init(x,z,Af)}if(w){w.init(Ai,Ag,Af)}if(Af.collapseIdentical){E=true;this.editor().operation(function(){L(Al,Af.collapseIdentical)});E=false}if(Af.connect=="align"){this.aligners=[];i(this.left||this.right,true)}var Ac=function(){if(Ah){l(Ah)}if(w){l(w)}};m.on(window,"resize",Ac);var Aj=setInterval(function(){for(var Am=Aa.parentNode;Am&&Am!=document.body;Am=Am.parentNode){}if(!Am){clearInterval(Aj);m.off(window,"resize",Ac)}},5000)};function d(y){var w=y.lockButton=c("div",null,"CodeMirror-merge-scrolllock");w.title="Toggle locked scrolling";var z=c("div",[w],"CodeMirror-merge-scrolllock-wrap");m.on(w,"click",function(){q(y,!y.lockScroll)});var x=[z];if(y.mv.options.revertButtons!==false){y.copyButtons=c("div",null,"CodeMirror-merge-copybuttons-"+y.type);m.on(y.copyButtons,"click",function(Aa){var Ab=Aa.target||Aa.srcElement;if(!Ab.chunk){return}if(Ab.className=="CodeMirror-merge-copy-reverse"){k(y,y.orig,y.edit,Ab.chunk);return}k(y,y.edit,y.orig,Ab.chunk)});x.unshift(y.copyButtons)}if(y.mv.options.connect!="align"){var v=document.createElementNS&&document.createElementNS(h,"svg");if(v&&!v.createSVGRect){v=null}y.svg=v;if(v){x.push(v)}}return y.gap=c("div",x,"CodeMirror-merge-gap")}S.prototype={constuctor:S,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(v){if(this.right){this.right.setShowDifferences(v)}if(this.left){this.left.setShowDifferences(v)}},rightChunks:function(){if(this.right){T(this.right);return this.right.chunks}},leftChunks:function(){if(this.left){T(this.left);return this.left.chunks}}};function H(v){if(typeof v=="string"){return v}else{return v.getValue()}}var W=new K();function Q(y,x){var z=W.diff_main(y,x);W.diff_cleanupSemantic(z);for(var v=0;v<z.length;++v){var w=z[v];if(!w[1]){z.splice(v--,1)}else{if(v&&z[v-1][0]==w[0]){z.splice(v--,1);z[v][1]+=w[1]}}}return z}function o(Ab){var Ah=[];var y=0,x=0;var Ac=Z(0,0),Aj=Z(0,0);for(var Ad=0;Ad<Ab.length;++Ad){var Af=Ab[Ad],Aa=Af[0];if(Aa==DIFF_EQUAL){var v=t(Ab,Ad)?0:1;var Ag=Ac.line+v,z=Aj.line+v;g(Ac,Af[1],null,Aj);var Ai=b(Ab,Ad)?1:0;var Ae=Ac.line+Ai,w=Aj.line+Ai;if(Ae>Ag){if(Ad){Ah.push({origFrom:x,origTo:z,editFrom:y,editTo:Ag})}y=Ae;x=w}}else{g(Aa==DIFF_INSERT?Ac:Aj,Af[1])}}if(y<=Ac.line||x<=Aj.line){Ah.push({origFrom:x,origTo:Aj.line+1,editFrom:y,editTo:Ac.line+1})}return Ah}function b(x,v){if(v==x.length-1){return true}var w=x[v+1][1];if(w.length==1||w.charCodeAt(0)!=10){return false}if(v==x.length-2){return true}w=x[v+2][1];return w.length>1&&w.charCodeAt(0)==10}function t(x,v){if(v==0){return true}var w=x[v-1][1];if(w.charCodeAt(w.length-1)!=10){return false}if(v==1){return true}w=x[v-2][1];return w.charCodeAt(w.length-1)==10}function V(Ad,Ac,Af){var v,Ae,y,z;for(var Ab=0;Ab<Ad.length;Ab++){var Aa=Ad[Ab];var x=Af?Aa.editFrom:Aa.origFrom;var w=Af?Aa.editTo:Aa.origTo;if(Ae==null){if(x>Ac){Ae=Aa.editFrom;z=Aa.origFrom}else{if(w>Ac){Ae=Aa.editTo;z=Aa.origTo}}}if(w<=Ac){v=Aa.editTo;y=Aa.origTo}else{if(x<=Ac){v=Aa.editFrom;y=Aa.origFrom}}}return{edit:{before:v,after:Ae},orig:{before:y,after:z}}}function N(z,v,w){z.addLineClass(v,"wrap","CodeMirror-merge-collapsed-line");var y=document.createElement("span");y.className="CodeMirror-merge-collapsed-widget";y.title="Identical text collapsed. Click to expand.";var Aa=z.markText(Z(v,0),Z(w-1),{inclusiveLeft:true,inclusiveRight:true,replacedWith:y,clearOnEnter:true});function x(){Aa.clear();z.removeLineClass(v,"wrap","CodeMirror-merge-collapsed-line")}y.addEventListener("click",x);return{mark:Aa,clear:x}}function u(v,y){var Ab=[];function Aa(){for(var Ac=0;Ac<Ab.length;Ac++){Ab[Ac].clear()}}for(var w=0;w<y.length;w++){var z=y[w];var x=N(z.cm,z.line,z.line+v);Ab.push(x);x.mark.on("clear",Aa)}return Ab[0].mark}function Y(w,v,Ab,Ac){for(var y=0;y<w.chunks.length;y++){var z=w.chunks[y];for(var Aa=z.editFrom-v;Aa<z.editTo+v;Aa++){var x=Aa+Ab;if(x>=0&&x<Ac.length){Ac[x]=false}}}}function L(Ae,z){if(typeof z!="number"){z=2}var Ag=[],Aa=Ae.editor(),Af=Aa.firstLine();for(var Ac=Af,v=Aa.lastLine();Ac<=v;Ac++){Ag.push(true)}if(Ae.left){Y(Ae.left,z,Af,Ag)}if(Ae.right){Y(Ae.right,z,Af,Ag)}for(var Ad=0;Ad<Ag.length;Ad++){if(Ag[Ad]){var w=Ad+Af;for(var x=1;Ad<Ag.length-1&&Ag[Ad+1];Ad++,x++){}if(x>z){var Ab=[{line:w,cm:Aa}];if(Ae.left){Ab.push({line:a(w,Ae.left.chunks),cm:Ae.left.orig})}if(Ae.right){Ab.push({line:a(w,Ae.right.chunks),cm:Ae.right.orig})}var y=u(x,Ab);if(Ae.options.onCollapse){Ae.options.onCollapse(Ae,w,x,y)}}}}}function c(v,Aa,w,z){var x=document.createElement(v);if(w){x.className=w}if(z){x.style.cssText=z}if(typeof Aa=="string"){x.appendChild(document.createTextNode(Aa))}else{if(Aa){for(var y=0;y<Aa.length;++y){x.appendChild(Aa[y])}}}return x}function F(w){for(var v=w.childNodes.length;v>0;--v){w.removeChild(w.firstChild)}}function M(w){for(var v=1;v<arguments.length;v+=2){w.setAttribute(arguments[v],arguments[v+1])}}function C(v,x){if(!x){x={}}for(var w in v){if(v.hasOwnProperty(w)){x[w]=v[w]}}return x}function g(w,y,z,Ab){var x=z?Z(w.line,w.ch):w,Aa=0;for(;;){var v=y.indexOf("\n",Aa);if(v==-1){break}++x.line;if(Ab){++Ab.line}Aa=v+1}x.ch=(Aa?0:x.ch)+(y.length-Aa);if(Ab){Ab.ch=(Aa?0:Ab.ch)+(y.length-Aa)}return x}function O(w,v){return(w.line-v.line||w.ch-v.ch)<0?w:v}function P(w,v){return(w.line-v.line||w.ch-v.ch)>0?w:v}function J(w,v){return w.line==v.line&&w.ch==v.ch}function I(Aa,z,y){for(var w=Aa.length-1;w>=0;w--){var v=Aa[w];var x=(y?v.origTo:v.editTo)-1;if(x<z){return x}}}function A(Aa,z,y){for(var w=0;w<Aa.length;w++){var v=Aa[w];var x=(y?v.origFrom:v.editFrom);if(x>z){return x}}}function G(z,x){var Ab=null,v=z.state.diffViews,w=z.getCursor().line;if(v){for(var Aa=0;Aa<v.length;Aa++){var y=v[Aa],Ad=z==y.orig;T(y);var Ac=x<0?I(y.chunks,w,Ad):A(y.chunks,w,Ad);if(Ac!=null&&(Ab==null||(x<0?Ac>Ab:Ac<Ab))){Ab=Ac}}}if(Ab!=null){z.setCursor(Ab,0)}else{return m.Pass}}m.commands.goNextDiff=function(v){return G(v,1)};m.commands.goPrevDiff=function(v){return G(v,-1)}});