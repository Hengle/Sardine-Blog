(function(A){if(typeof exports=="object"&&typeof module=="object"){A(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],A)}else{A(CodeMirror)}}})(function(G){function E(U,T){if(typeof U=="string"){U=new RegExp(U.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),T?"gi":"g")}else{if(!U.global){U=new RegExp(U.source,U.ignoreCase?"gi":"g")}}return{token:function(W){U.lastIndex=W.pos;var V=U.exec(W.string);if(V&&V.index==W.pos){W.pos+=V[0].length;return"searching"}else{if(V){W.pos=V.index}else{W.skipToEnd()}}}}}function D(){this.posFrom=this.posTo=this.lastQuery=this.query=null;this.overlay=null}function P(T){return T.state.search||(T.state.search=new D())}function N(T){return typeof T=="string"&&T==T.toLowerCase()}function C(V,U,T){return V.getSearchCursor(U,T,N(U))}function S(V,U,T,W){V.openDialog(U,W,{value:T,selectValueOnOpen:true,closeOnEnter:false,onClose:function(){I(V)}})}function F(W,V,U,T,X){if(W.openDialog){W.openDialog(V,X,{value:T,selectValueOnOpen:true})}else{X(prompt(U,T))}}function R(W,V,U,T){if(W.openConfirm){W.openConfirm(V,T)}else{if(confirm(U)){T[0]()}}}function L(U){var V=U.match(/^\/(.*)\/([a-z]*)$/);if(V){try{U=new RegExp(V[1],V[2].indexOf("i")==-1?"":"i")}catch(T){}}if(typeof U=="string"?U=="":U.test("")){U=/x^/}return U}var O='Search: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>';function J(U,V,T){V.queryText=T;V.query=L(T);U.removeOverlay(V.overlay,N(V.query));V.overlay=E(V.query,N(V.query));U.addOverlay(V.overlay);if(U.showMatchesOnScrollbar){if(V.annotate){V.annotate.clear();V.annotate=null}V.annotate=U.showMatchesOnScrollbar(V.query,N(V.query))}}function K(W,V,T){var X=P(W);if(X.query){return M(W,V)}var U=W.getSelection()||X.lastQuery;if(T&&W.openDialog){S(W,O,U,function(Y,Z){G.e_stop(Z);if(!Y){return}if(Y!=X.queryText){J(W,X,Y)}M(W,Z.shiftKey)})}else{F(W,O,"Search for:",U,function(Y){if(Y&&!X.query){W.operation(function(){J(W,X,Y);X.posFrom=X.posTo=W.getCursor();M(W,V)})}})}}function M(U,T){U.operation(function(){var W=P(U);var V=C(U,W.query,T?W.posFrom:W.posTo);if(!V.find(T)){V=C(U,W.query,T?G.Pos(U.lastLine()):G.Pos(U.firstLine(),0));if(!V.find(T)){return}}U.setSelection(V.from(),V.to());U.scrollIntoView({from:V.from(),to:V.to()},20);W.posFrom=V.from();W.posTo=V.to()})}function I(T){T.operation(function(){var U=P(T);U.lastQuery=U.query;if(!U.query){return}U.query=U.queryText=null;T.removeOverlay(U.overlay);if(U.annotate){U.annotate.clear();U.annotate=null}})}var A='Replace: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>';var H='With: <input type="text" style="width: 10em" class="CodeMirror-search-field"/>';var Q="Replace? <button>Yes</button> <button>No</button> <button>Stop</button>";function B(V,T){if(V.getOption("readOnly")){return}var U=V.getSelection()||P(V).lastQuery;F(V,A,"Replace:",U,function(W){if(!W){return}W=L(W);F(V,H,"Replace with:","",function(Z){if(T){V.operation(function(){for(var b=C(V,W);b.findNext();){if(typeof W!="string"){var c=V.getRange(b.from(),b.to()).match(W);b.replace(Z.replace(/\$(\d)/g,function(e,d){return c[d]}))}else{b.replace(Z)}}})}else{I(V);var X=C(V,W,V.getCursor());var Y=function(){var c=X.from(),b;if(!(b=X.findNext())){X=C(V,W);if(!(b=X.findNext())||(c&&X.from().line==c.line&&X.from().ch==c.ch)){return}}V.setSelection(X.from(),X.to());V.scrollIntoView({from:X.from(),to:X.to()});R(V,Q,"Replace?",[function(){a(b)},Y])};var a=function(b){X.replace(typeof W=="string"?Z:Z.replace(/\$(\d)/g,function(d,c){return b[c]}));Y()};Y()}})})}G.commands.find=function(T){I(T);K(T)};G.commands.findPersistent=function(T){I(T);K(T,false,true)};G.commands.findNext=K;G.commands.findPrev=function(T){K(T,true)};G.commands.clearSearch=I;G.commands.replace=B;G.commands.replaceAll=function(T){B(T,true)}});